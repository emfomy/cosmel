<!DOCTYPE HTML>
<!--
	Stellar by HTML5 UP
	html5up.net | @ajlkn
	Free for personal and commercial use under the CCA 3.0 license (html5up.net/license)
-->
<html>
	<head>
		<title>[{{ ver }}] {{ part }}/{{ aid }}</title>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1" />
		<link rel="apple-touch-icon" sizes="180x180" href="/static/favicon/apple-touch-icon.png">
		<link rel="icon" type="image/png" sizes="32x32" href="/static/favicon/favicon-32x32.png">
		<link rel="icon" type="image/png" sizes="16x16" href="/static/favicon/favicon-16x16.png">
		<link rel="manifest" href="/static/favicon/site.webmanifest">
		<link rel="mask-icon" href="/static/favicon/safari-pinned-tab.svg" color="#5bbad5">
		<link rel="shortcut icon" href="/static/favicon/favicon.ico">
		<meta name="msapplication-TileColor" content="#2b5797">
		<meta name="msapplication-config" content="/static/favicon/browserconfig.xml">
		<meta name="theme-color" content="#ffffff">
		<link rel="stylesheet" href="static/assets/css/main.css" />
		<style>
			img {
				max-width: 100%;
			}

			#main > article > .counter {
				font-size: 100px;
				position: fixed;
				top: 10%;
				right: 10%;
				cursor: pointer;
			}

			#main > article > .article {
				margin: 5%;
			}

			product {
				background-color: #ffdddd;
				border-left: 6px solid #f44336;
				cursor: pointer;
			}

			product[gid]:not([gid=""]) {
				background-color: #ddffdd;
				border-left: 6px solid #43f436;
			}

			product::before, product::after {
				font-size: 24px;
				font-weight: bold;
				position: relative;
				top: 10pt;
			}

			product::before {
				content: "üò±„ÄÄ";
				position: absolute;
				right: 0;
				top: unset;
			}

			product[gid]:not([gid=""])::before {
				content: "„ÄÄüòç";
			}

			product::after {
				color: #aa0000;
				/*content: "Here!";*/
				content: attr(pid) "?";
			}

			product[gid]:not([gid=""])::after {
				color: #00aa00;
				content: attr(gid);
			}
		</style>
	</head>
	<body>

		<!-- Wrapper -->
			<div id="wrapper">

				<!-- Header -->
					<header id="header">
					</header>

				<!-- Nav -->
					<nav id="nav">
						<form class="form-inline" method="GET">
							<ul>
								<li><a href="?part={{ part }}&aid={{ aid }}&act=prev" title="Prev" class="icon fa-angle-double-left"></a></li>
								<li>
									<select id="part" name="part" class="selectpicker form-control">
										{% for p in files %}
											{% if p == part %}
												<option value="{{ p }}" selected>{{ p }}</option>
											{% else %}
												<option value="{{ p }}">{{ p }}</option>
											{% endif %}
										{% endfor %}
									</select>
								</li>
								<li>
									<select id="aid" name="aid" class="selectpicker form-control">
										<option value=""></option>
										{% for f in files[part] %}
											{% if f == None %}
											{% elif f == aid %}
												<option value="{{ f }}" selected>{{ f }}</option>
											{% else %}
												<option value="{{ f }}">{{ f }}</option>
											{% endif %}
										{% endfor %}
									</select>
								</li>
								<li><a href="?part={{ part }}&aid={{ aid }}&act=next" title="Next" class="icon fa-angle-double-right"></a></li>
							</ul>
							<ul>
								<li><a href="/repo/product?brand=sk2" target="_blank">?brand=sk2</a></li>
								<li><a href="/repo/product?head=Èù¢ËÜú" target="_blank">?head=Èù¢ËÜú</a></li>
								<li><a href="/repo/product?brand=sk2&head=Èù¢ËÜú" target="_blank">?brand=sk2&amp;head=Èù¢ËÜú</a></li>
								<li><a href="/repo/product?pid=8,11" target="_blank">?pid=8,11</a></li>
							</ul>
						</form>
					</nav>

				<!-- Main -->
					<div id="main">

						<article>
							<span class="counter"></span>
							<br>
							<div class="article" w3-include-html="/article/{{ part }}/{{ aid }}"></div>
							<hr>
							<center><div class="json" w3-include-html="/json/{{ part }}/{{ aid }}"></div></center>
							<br>
						</article>

					</div>

				<!-- Footer -->
					<footer id="footer">
						<section>
							<ul class="icons">
								<li><a href="?part={{ part }}&aid={{ aid }}&act=prev" class="icon fa-angle-double-left alt"><span class="label">Prev</span></a></li>
								<li><a href="?part={{ part }}&aid={{ aid }}&act=next" class="icon fa-angle-double-right alt"><span class="label">Next</span></a></li>
							</ul>
							<form class="form-inline" method="GET">
								<select id="part2" name="part" class="selectpicker form-control">
									{% for p in files %}
										{% if p == part %}
											<option value="{{ p }}" selected>{{ p }}</option>
										{% else %}
											<option value="{{ p }}">{{ p }}</option>
										{% endif %}
									{% endfor %}
								</select>
								<select id="aid2" name="aid" class="selectpicker form-control">
									<option value=""></option>
									{% for f in files[part] %}
										{% if f == None %}
										{% elif f == aid %}
											<option value="{{ f }}" selected>{{ f }}</option>
										{% else %}
											<option value="{{ f }}">{{ f }}</option>
										{% endif %}
									{% endfor %}
								</select>
							</form>
							<p>
								<a href="/repo/product?brand=sk2" target="_blank">?brand=sk2</a>&emsp;
								<a href="/repo/product?head=Èù¢ËÜú" target="_blank">?head=Èù¢ËÜú</a>&emsp;
								<a href="/repo/product?brand=sk2&head=Èù¢ËÜú" target="_blank">?brand=sk2&amp;head=Èù¢ËÜú</a>&emsp;
								<a href="/repo/product?pid=8,11" target="_blank">?pid=8,11</a>
							</p>
							<p class="copyright">Copyright ¬© Mu Yang. All rights reserved.</p>
						</section>
					</footer>

			</div>

		<!-- Scripts -->
			<script src="static/assets/js/jquery.min.js"></script>
			<script src="static/assets/js/jquery.scrollex.min.js"></script>
			<script src="static/assets/js/jquery.scrolly.min.js"></script>
			<script src="static/assets/js/skel.min.js"></script>
			<script src="static/assets/js/util.js"></script>
			<script src="static/assets/js/main.js"></script>
			<script src="static/assets/js/sweetalert.modified.min.js"></script>
			<script src="https://www.w3schools.com/lib/w3.js"></script>

			<script type="text/javascript">
				$('#part').change(function() { this.form.submit(); });
				$('#aid').change(function() { this.form.submit(); });
				$('#part2').change(function() { this.form.submit(); });
				$('#aid2').change(function() { this.form.submit(); });

				function updateCounter() {
					var e = $('#main > article > .counter');
					e.text($('product:not([gid]:not([gid=""]))').length + '/' + $('product').length);
					e.click(function() {
						const top = $('product:not([gid]:not([gid=""])), #footer').offset().top;
						const middle = top - (window.innerHeight / 2);
						window.scrollTo(0, middle);
					});
				}

				w3.includeHTML(function(){
					$('#main > article > .article a').each(
						(i, e) => $(e).removeAttr('href')
					);

					$('product').each(
						(i, e) => $(e).attr('id', $(e).attr('sid') + '-' + $(e).attr('mid'))
					);

					{% for k, attrs in mention_data.items() %}
						var e = $('product#{{ k }}');
						if ( e.length ) {
							{% for a, v in attrs.items() %}
								$('product#{{ k }}').attr('{{ a }}', '{{ v }}');
							{% endfor %}
						} else {
							alert('No "product#{{k}}"!');
						}
					{% endfor %}

					{% for k, attrs in json_data.items() %}
						var e = $('product#{{ k }}');
						if ( e.length ) {
							{% for a, v in attrs.items() %}
								$('product#{{ k }}').attr('{{ a }}', '{{ v }}');
							{% endfor %}
						} else {
							alert('No "product#{{k}}"!');
						}
					{% endfor %}

					while ($('product product').length > 0) {
						$('product product').each(
							(i, e) => {
								alert('Remove "product#' + $(e)[0].id + '"!');
								$(e).replaceWith('<notproduct>' + $(e).html() + '</notproduct>');
							}
						);
					}

					updateCounter();

					document.querySelectorAll('product').forEach(
						e => $(e).click(function() {
							try {
								const text = this.innerText;
								const pid  = $(this).attr('pid');
								const gid  = $(this).attr('gid');
								const sid  = $(this).attr('sid');
								const mid  = $(this).attr('mid');
								const rule = $(this).attr('rule');
								const hint_orig = $(this).attr('hint');
								const hint = hint_orig ? hint_orig : '';

								const pgh = pid+';'+gid+';'+hint;

								res = $.ajax({
									url: '/repo/product?pid='+pgh,
									type: 'get',
									error: customStatusError
								}).done(pgh_name => {
									pgh_list  = pgh_name.split('<hr>');
									pid_name  = pgh_list[0].replace(/<br>/g, '\n');
									gid_name  = pgh_list[1].replace(/<br>/g, '\n');
									hint_name = pgh_list[2].replace(/<br>/g, '\n');

									var buttons = {
										'~': true,
										OSP: true,
										GP: true,
										NAP: true,
										delete: true,
										cancel: true
									}
									for ( var h of (pid+','+gid+','+hint).split(',') ) {
										if ( h && h != '~' ) {
											buttons[h] = true;
										}
									}

									swal({
										title: text,
										text:
											'pid='+pid_name +'\n'+
											'gid='+gid_name +'\n'+
											'sid='+sid +'\n'+
											'mid='+mid +'\n'+
											'rule='+rule +'\n'+
											'hint='+hint +'\n'+hint_name,
										content: "input",
										buttons: buttons
									}).then((value) => {
										if ( value === null ) {
											return;
										}
										switch (value) {
											case 'delete':
												value = ''
											case 'OSP':
											case 'GP':
											case 'NAP':
											default:

												$(this).attr('gid', value);
												updateCounter();

												const data = {
													pid:  pid,
													gid:  value,
													sid:  sid,
													mid:  mid,
													rule: rule,
													hint: hint
												};

												fetch('/save?part={{ part }}&aid={{ aid }}', {
													method: 'POST',
													body: JSON.stringify(data)
												})
												.then(res => {
													if (res.ok) {
														res.json().then(customStatusSuccess);
													} else {
														res.json().then(res2 => customStatusError2(res, res2));
													}
												}).catch(customError);
										}
									});
									$('button.swal-button--cancel').parent().before('<hr>')
									$('button.swal-button--OSP').parent().before('<hr>')
								});

							} catch(error) {
								customError(error);
							}
						})
					)
				});

				function customSuccess(message) {
					console.log('Success:', message);
				}

				function customStatusSuccess(res) {
					customSuccess(res.message);
				}

				function customError(message) {
					swal(message, '', 'error');
					console.error('Error:', message);
				}

				function customStatusError(res) {
					customError('[' + res.status + '] ' + res.statusText);
				}

				function customStatusError2(res, res2) {
					customError('[' + res.status + '] ' + res.statusText + '\n' + res2.message);
				}
			</script>

	</body>
</html>
